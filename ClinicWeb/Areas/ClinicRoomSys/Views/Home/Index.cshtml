@{
    ViewData["Title"] = "看診系統";
}
@section ModulesStyles
{
    <!-- iCheck -->
    <link href="~/vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Datatables -->

    <link href="~/vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="~/vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="~/vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="~/vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="~/vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">

    <!-- Switchery -->
    <link href="~/vendors/switchery/dist/switchery.min.css" rel="stylesheet">
    <!-- PNotify -->
    <link href="~/vendors/pnotify/dist/pnotify.css" rel="stylesheet">
    <link href="~/vendors/pnotify/dist/pnotify.buttons.css" rel="stylesheet">
    <link href="~/vendors/pnotify/dist/pnotify.nonblock.css" rel="stylesheet">

    <!-- 自訂: 更新後顏色閃爍 -->
    <link href="~/msit155e/css/appointment/extension_datachanged_coloranimate.css" rel="stylesheet" />
}
@section Styles
{
    <link href="~/msit155e/css/clinicroomsys/_callingpanelpartial.css" rel="stylesheet" />
}

@*左側*@
<partial name="/Areas/ClinicRoomSys/Views/CallingSys/_CallingPanelPartial.cshtml" />
@*右側*@
<partial name="/Areas/ClinicRoomSys/Views/Cases/_CasesPartial.cshtml" />

@section Scripts
{
    <script>
        //宣告全域變數
        //選取的會員(病患)ID
        let MEMBER_ID = 1;
        //病患掛號序列
        let CLINICLIST_ID;
        //醫生員工ID
        let DOCTOR_ID;
        //選擇門診時間 (常理應該要選今天，為了demo寫死)
        let CLINIC_DATE = new Date("2024/02/01");
        //病歷ID
        let CASE_ID;

        //撈取狀態: 員工id
        (async () => {
            const response = await fetch('@Url.Content("~/ClinicRoomSys/CallingSys/Get_EmpId")', { method: 'POST' });
            const memberData = await response.text()
            DOCTOR_ID = memberData
            getCase(MEMBER_ID);
        })();

        //點選左表後觸發的事件 fetch右表
        async function on_memberClick()
        {
            console.log(`selected 會員ID MEMBER_ID: ${MEMBER_ID}, 掛號序列ID CLINICLIST_ID: ${CLINICLIST_ID}`);
            getCase(MEMBER_ID);
            // const response = await fetch('')
            // const data = await response.json()
        }
        //獲得主要病歷表資料
        async function getCase(id) {
            const response = await fetch(`/ClinicRoomSys/Cases/GM/${id}`, { method: "POST" })
            const data = await response.json();
            console.log(data);
            CASE_ID = data.casesID;
            console.log(CASE_ID);
            const record = getRecord(CASE_ID);
            console.log(record);
            $('#recordDataTable').DataTable({
                columns: [
                    { title: "看診紀錄ID", data: "recordID", visible: false },
                    { title: "血壓", data: "bloodPresure"},
                    { title: "脈搏", data: "pulse" },
                    { title: "體溫", data: "bodyTemparture"},
                    { title: "主述", data: "chiefComplaint"},
                    { title: "醫囑", data: "disposal"},
                    { title: "處方", data: "prescribe"},
                ],
                fixedHeader: {
                    header: true
                },
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json"
                }
            });
            // $('#recordDataTable').DataTable().clear();
            // $('#recordDataTable').DataTable().rows.add(record).draw();
            $('#reportDataTable').DataTable({
                columns: [
                    { title: "報告ID", data: "reportID", visible: false },
                    { title: "檢查名稱", data: "testName" },
                    { title: "檢查日期", data: "testDate" },
                    { title: "報告日期", data: "reportDate" },
                    { title: "結果", data: "result" },
                ],
                fixedHeader: {
                    header: true
                },
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json"
                }
            });
            $('#prescriptionDataTable').DataTable({
                columns: [
                    { title: "處方ID", data: "prescriptionID", visible: false },
                    { title: "處方日期", data: "prescriptionDate" },
                    { title: "調劑方式", data: "dispensing" },
                ],
                fixedHeader: {
                    header: true
                },
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json"
                }
            });
            const report = getReport(CASE_ID);
            console.log(report);
            const prescription = getPrescription(CASE_ID);
            console.log(prescription);
        }

        //獲得看診紀錄資料
        async function getRecord(id) {
            const response = await fetch(`/ClinicRoomSys/Cases/GRD/${id}`, { method: "POST" })
            const data = await response.json();
            // return data;
            $('#recordDataTable').DataTable().rows.add(data).draw();
        }
        //獲得檢查報告資料
        async function getReport(id) {
            const response = await fetch(`/ClinicRoomSys/Cases/GRT/${id}`, { method: "POST" })
            const data = await response.json();
            //return data;
            $('#reportDataTable').DataTable().rows.add(data).draw();
        }
        //獲得處方資料
        async function getPrescription(id) {
            const response = await fetch(`/ClinicRoomSys/Cases/GP/${id}`, { method: "POST" })
            const data = await response.json();
            //return data;
            $('#prescriptionDataTable').DataTable().rows.add(data).draw();
        }



        
    </script>
    <script src="~/msit155e/js/clinicroomsys/_callingpanelpartial.js"></script>
}
@section Modules
{
    <!-- iCheck -->
    <script src="~/vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="~/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    @* <script src="~/lib/datatables/js/jquery.datatables.min.js"></script> *@
    <script src="~/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="~/vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="~/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="~/vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="~/vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="~/vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="~/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="~/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="~/vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="~/vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="~/vendors/jszip/dist/jszip.min.js"></script>
    <script src="~/vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="~/vendors/pdfmake/build/vfs_fonts.js"></script>
    <!-- Switchery -->
    <script src="~/vendors/switchery/dist/switchery.min.js"></script>
    <!-- PNotify -->
    <script src="~/vendors/pnotify/dist/pnotify.js"></script>
    <script src="~/vendors/pnotify/dist/pnotify.buttons.js"></script>
    <script src="~/vendors/pnotify/dist/pnotify.nonblock.js"></script>

    <!-- datatable jumptodata -->
    <script src="https://cdn.datatables.net/plug-ins/1.13.7/api/page.jumpToData().js" asp-fallback-src="~/lib/page.jumptodata().js"></script>

    <!-- 自訂: 更新後顏色閃爍 -->
    <script src="~/msit155e/js/appointment/extension_datachanged_coloranimate.js"></script>
}